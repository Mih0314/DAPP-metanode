# Geth 分层架构与关键模块说明

## 一、分层架构图

```
[P2P网络层]
    ├─ Node Discovery (discv4/discv5)
    ├─ RLPx/DevP2P Session (握手/加密/带宽控制)
    ├─ 子协议复用：eth/62、eth/63、les/2、snap 等
    ▼
[区块链协议层]
    ├─ eth/62, eth/63（全节点同步、区块/交易传播）
    ├─ snap（状态分片同步，快速恢复）
    ├─ les（轻节点协议，按需拉取）
    ├─ 共识接入（PoS 信标链引擎 API / 历史 PoW 验证）
    ▼
[状态存储层]
    ├─ LevelDB（键值存储）
    ├─ Patricia Merkle Trie（账户树/存储树/代码哈希）
    ├─ 状态快照（Snapshot，加速读取）
    ├─ 磁盘/缓存/修剪（pruning）策略
    ▼
[EVM 执行层]
    ├─ 交易执行（交易校验、Gas 计费、日志）
    ├─ 合约代码解释执行（EVM/evmone 接入）
    ├─ 预编译合约（椭圆曲线、hash等）
    ├─ 状态变更提交（账户余额/nonce/代码/存储）
```

---

## 一-2. 功能架构总览图（子系统/模块视角）

```
      ┌────────────────────────┐
      │    外部接口/API层      │
      │────────────────────────│
      │ JSON-RPC │ CLI │ GraphQL│
      └───────────┬────────────┘
                  │
      ┌───────────▼────────────┐
      │      节点服务总控      │
      │ Peer管理 │ Sync/Chain │
      └───────────┬────────────┘
                  │
 ┌─────┬──────────┼───────────┬─────┐
 │     │          │           │     │
 ▼     ▼          ▼           ▼     ▼
P2P网络 子协议调度 交易池管理 共识引擎 状态存储
层     &同步模块    TxPool    Ethash/POS  LevelDB/trie

        ┌───────────────┐
        │   EVM模块     │
        │执行(合约/Tx)  │
        └─────▲─────────┘
              │
         区块打包与验证
```
*说明：P2P网络与子协议负责数据流转与同步，交易池、EVM、存储、共识分别对应Geth的核心功能子系统。

---

## 二、各层说明（含关键模块）

（原内容保留，此处略）

---

## 新增：交易生命周期流程图与详解

```
  用户/外部Dapp
        │
        │(1)
        ▼
  JSON-RPC API（sendRawTransaction）
        │
        │(2) 校验&打包
        ▼
   交易池（TxPool）
   │去重/排序/合法性检查
        │
        │(3)
        ▼
   共识引擎（Ethash/POS）
   │出块者打包交易生成新区块
        │
        │(4) 区块内顺序提交EVM
        ▼
   EVM 执行（合约/转账/事件）
        │
        │(5) 状态更改&日志
        ▼
   状态存储(trie更新), Events
        │
        │(6) 网络广播
        ▼
   区块&tx同步给全网其他节点
```
- **步骤详解:**
  1. 用户/应用通过API提交交易，Geth进行格式、签名等初步校验
  2. 交易池接收、排序交易，丢弃低Gas/重复/错误交易
  3. 共识模块选择打包交易并生成新区块
  4. EVM模块按顺序逐条执行block.transactions，任何失败即回滚状态
  5. 执行结果写入状态树（trie），产生log事件
  6. 新区块全网广播，同步至其他节点

---

## 账户状态存储模型图与数据结构说明

### 账户状态存储结构模型（Patricia Trie/账户对象）

- **账户（Account）在链上以（key，value）对存于全网一致的状态树中**
- **账户分为普通EOA和合约账户**
- **每个账户的数据结构示意**：

```
账户树（Patricia Merkle Trie）
 ├─ key: keccak256(Address)
 │      ▼
 │    ┌──────────────────────────────┐
 │    │      Account State           │
 │    ├───────────┬──────────────────┤
 │    │nonce      │ 交易计数/防重放  │
 │    │balance    │ ETH余额          │
 │    │storageRoot│ 合约存储trie根   │
 │    │codeHash   │ 合约字节码哈希   │
 │    └───────────┴──────────────────┘
 │              │
 │              │（合约账户时storageRoot与codeHash有效, EOA则为空）
 │              ▼
 │         [存储树trie] (每合约一棵, 键值即slot)
 │              │
 │              ▼
 │   slotKey(Keccak256) : slotValue(32字节)
```

- Patricia Trie 提供高效、可验证和动态可分叉的存储（根哈希即整个链状态指纹，各节点间达成共识）
- 普通账户只有nonce、balance两字段有意义，合约账户有完整存储树(code、变量)

---

## 四、小结
- 分层解耦使 Geth 在网络、协议、存储、执行之间形成清晰边界；
- `les` 解决轻客户端按需可验证访问问题；
- `trie` 提供状态可验证性与一致性根，支撑 PoS 时代的执行客户端职责与跨节点验证。
